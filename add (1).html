<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Adicionar Dados - DTPO Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --background-color: #f4f6f9;
            --card-background: #ffffff;
            --text-color: #343a40;
            --text-muted: #6c757d;
            --border-color: #e2e8f0;
            --border-radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        /* --- Navegação Principal Responsiva --- */
        .main-header {
            background-color: var(--card-background);
            box-shadow: var(--shadow);
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 64px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .logo { font-size: 1.2rem; font-weight: 600; flex-shrink: 0; }
        
        .main-nav { display: flex; gap: 5px; }
        .main-nav a {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--text-muted);
            font-weight: 500;
            padding: 22px 10px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .main-nav a:hover, .main-nav a.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .user-controls { display: flex; align-items: center; gap: 15px; }
        .user-info { font-size: 0.9rem; color: var(--text-muted); }
        .admin-link { display: none; }
        .menu-toggle { display: none; background: none; border: none; cursor: pointer; padding: 5px; }

        .main-content {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .content-card {
            background: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px;
        }
        .content-card h3 { 
            margin-top: 0; 
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

        .form-group { margin-bottom: 20px; }
        label { font-weight: 600; display: block; margin-bottom: 5px; }
        input, select, textarea {
            padding: 10px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background-color: var(--card-background);
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
        }
        textarea { min-height: 150px; font-family: "Menlo", "Monaco", monospace; }

        button {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; border: 1px solid transparent; padding: 10px 15px;
            border-radius: var(--border-radius); font-weight: 500; text-decoration: none;
            transition: all 0.2s ease-in-out;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-success { background-color: #198754; color: white; }
        fieldset { border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 15px; margin-top: 20px; }
        legend { font-weight: bold; color: var(--primary-color); padding: 0 10px; }

        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: var(--border-radius); padding: 16px; position: fixed; z-index: 1001; left: 50%; top: 30px; font-size: 17px; opacity: 0; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: all 0.5s ease-in-out; }
        #toast.show { visibility: visible; opacity: 1; top: 80px; }
        #toast.success { background-color: #198754; }
        #toast.error { background-color: #dc3545; }

        /* =================================== */
        /* === MEDIA QUERIES PARA RESPONSIVIDADE === */
        /* =================================== */
        @media (max-width: 1024px) {
            .main-nav {
                display: none; flex-direction: column; position: absolute; top: 64px; left: 0; width: 100%;
                background-color: var(--card-background); box-shadow: var(--shadow); border-top: 1px solid var(--border-color);
            }
            .main-nav.nav-open { display: flex; }
            .main-nav a { padding: 15px 20px; border-bottom: 1px solid var(--border-color); }
            .main-nav a:hover, .main-nav a.active {
                border-bottom: 1px solid var(--border-color); background-color: var(--background-color);
            }
            .menu-toggle { display: block; }
        }

        @media (max-width: 767px) {
            .main-content, .main-header { padding: 0 15px; }
            .content-card { padding: 15px; }
        }
    </style>
</head>
<body>

<header class="main-header">
    <div class="header-left">
        <button class="menu-toggle" id="menuToggle" aria-label="Abrir menu">
            <i data-feather="menu"></i>
        </button>
        <div class="logo">DTPO Dashboard</div>
        <nav class="main-nav" id="mainNav">
            <a href="index.html"><i data-feather="home"></i>Dashboard</a>
            <a href="graficos.html"><i data-feather="pie-chart"></i>Gráficos</a>
            <a href="relatorio.html"><i data-feather="file-text"></i>Relatórios</a>
            <a href="add.html" class="admin-link active"><i data-feather="plus-circle"></i>Adicionar Dados</a>
            <a href="delete.html" class="admin-link"><i data-feather="trash-2"></i>Excluir Dados</a>
        </nav>
    </div>
    <div class="user-controls">
        <div class="user-info">
            Bem-vindo, <span id="userDisplay">Visitante</span>!
        </div>
    </div>
</header>

<div class="main-content">
    <div class="content-card">
        <h3>Adicionar Lançamento Mensal</h3>
        <div class="form-group">
            <label for="dataInput">Período (Mês/Ano):</label>
            <input type="month" id="dataInput" required />
        </div>
        <div class="form-group">
            <label for="setorInput">Setor:</label>
            <select id="setorInput" onchange="gerarCampos()"></select>
        </div>
        
        <div id="camposDinamicos"></div>

        <button onclick="adicionarDados()" class="btn-success" style="width: 100%; margin-top: 20px;">
            <i data-feather="save"></i> Salvar Registro
        </button>
    </div>
</div>

<div id="toast"></div>

<script>
// ===================================================================================
// CONFIG.JS (embutido)
// ===================================================================================
const camposConfig = {
    'sol_156_recebidas': { nome: 'Solicitações 156 Recebidas', tipo: 'numero' }, 'sol_156_respondidas': { nome: 'Solicitações 156 Respondidas', tipo: 'numero' }, 'vistorias': { nome: 'Vistorias', tipo: 'numero' },
    'coc_alvaras_impl_manut': { nome: 'Alvarás Impl./Manut.', tipo: 'numero' }, 'coc_notif_sistema': { nome: 'Notificações via sistema', tipo: 'numero' }, 'coc_notif_email': { nome: 'Notificações por email', tipo: 'numero' }, 'coc_multas_qtd': { nome: 'Multas (Quantidade)', tipo: 'numero' }, 'coc_arrec_alvaras': { nome: 'Arrecadação Alvarás', tipo: 'moeda' }, 'coc_arrec_multas': { nome: 'Arrecadação Multas', tipo: 'moeda' },
    'dtpo3g_atend_sup': { nome: 'Atendidos SUP e relatórios', tipo: 'numero' }, 'dtpo3g_amt': { nome: 'AMT (novos)', tipo: 'numero' }, 'dtpo3g_rap_pgt': { nome: 'RAP e PGT', tipo: 'numero' }, 'dtpo3g_pesquisa': { nome: 'Pesquisa', tipo: 'numero' }, 'dtpo3g_reunioes': { nome: 'Reuniões', tipo: 'numero' }, 'dtpo3g_emails_respondidos': { nome: 'Emails respondidos', tipo: 'numero' }, 'dtpo3g_rev_prog_semaforica': { nome: 'Revisão prog. semafórica', tipo: 'numero' }, 'dtpo3g_alt_sema_prog': { nome: 'Alterações Semafóricas Programadas', tipo: 'numero' }, 'dtpo3g_alt_sema_nao_prog': { nome: 'Alterações Semafóricas Não Programadas', tipo: 'numero' }, 'dtpo3g_analise_sydle': { nome: 'Análise de projetos viários (SYDLE)', tipo: 'numero' }, 'dtpo3g_op_obras': { nome: 'Operação em obras viárias', tipo: 'numero' }, 'dtpo3g_novos_croquis': { nome: 'Elaboração de novos croquis', tipo: 'numero' }, 'dtpo3g_vida_transito': { nome: 'Análise de Acidentes', tipo: 'numero' }, 'dtpo3g_fisc_contratos': { nome: 'Fiscalização de Contratos', tipo: 'numero' }, 'dtpo3g_reuniao_cmu': { nome: 'Reunião CMU', tipo: 'numero' }, 'dtpo3g_autorizacoes': { nome: 'Autorizações', tipo: 'numero' },
    'dtpo2_serv_equipe_propria': { nome: 'Serviços pela Equipe Própria', tipo: 'numero' }, 'dtpo2_serv_contrato_dataprom': { nome: 'Serviços via Contrato Dataprom', tipo: 'numero' }, 'dtpo2_serv_licitacao_smop': { nome: 'Serviços via Licitação SMOP', tipo: 'numero' }, 'dtpo2_servcomp_analise_projetos': { nome: 'Análise e Correção de Projetos', tipo: 'numero' }, 'dtpo2_servcomp_elaboracao_projeto': { nome: 'Solicitação de Elaboração de Projeto', tipo: 'numero' }, 'dtpo2_servcomp_acomp_obras_mitig': { nome: 'Acompanhamentos de Obras (mitigadoras)', tipo: 'numero' }, 'dtpo2_servcomp_vistorias_contrato': { nome: 'Vistorias de Obra (Contrato Dataprom)', tipo: 'numero' }, 'dtpo2_pedestre_implantados': { nome: 'Porta-Focos de Pedestre Implantados', tipo: 'numero' }, 'dtpo2_pedestre_revitalizados': { nome: 'Porta-Focos de Pedestre Revitalizados', tipo: 'numero' }
};
const gruposConfig = {
    'geral_unificado': { nome: 'Resumo Geral Unificado', campos: ['sol_156_recebidas', 'sol_156_respondidas', 'vistorias'] },
    'coc_atividades': { nome: 'Atividades COC', campos: ['coc_alvaras_impl_manut', 'coc_notif_sistema', 'coc_notif_email', 'coc_multas_qtd'] }, 'coc_arrecadacao': { nome: 'Arrecadação COC', campos: ['coc_arrec_alvaras', 'coc_arrec_multas'] },
    'dtpo3g_atendimentos': { nome: 'Atendimentos DTPO-3G', campos: ['dtpo3g_atend_sup', 'dtpo3g_emails_respondidos'] }, 'dtpo3g_analises': { nome: 'Análises e Vistorias DTPO-3G', campos: ['dtpo3g_amt', 'dtpo3g_rap_pgt', 'dtpo3g_pesquisa', 'dtpo3g_analise_sydle', 'dtpo3g_novos_croquis'] }, 'dtpo3g_operacional': { nome: 'Operacional DTPO-3G', campos: ['dtpo3g_reunioes', 'dtpo3g_rev_prog_semaforica', 'dtpo3g_alt_sema_prog', 'dtpo3g_alt_sema_nao_prog', 'dtpo3g_op_obras', 'dtpo3g_vida_transito', 'dtpo3g_fisc_contratos', 'dtpo3g_reuniao_cmu', 'dtpo3g_autorizacoes'] },
    'dtpo2_servicos': { nome: 'Serviços em Semáforos DTPO-2', campos: ['dtpo2_serv_equipe_propria', 'dtpo2_serv_contrato_dataprom', 'dtpo2_serv_licitacao_smop'] }, 'dtpo2_complementar': { nome: 'Serviços Complementares DTPO-2', campos: ['dtpo2_servcomp_analise_projetos', 'dtpo2_servcomp_elaboracao_projeto', 'dtpo2_servcomp_acomp_obras_mitig', 'dtpo2_servcomp_vistorias_contrato'] }, 'dtpo2_pedestre': { nome: 'Semáforos de Pedestre DTPO-2', campos: ['dtpo2_pedestre_implantados', 'dtpo2_pedestre_revitalizados'] }
};
const setoresConfig = {
    'coc': { nome: 'COC', grupos: ['geral_unificado', 'coc_atividades', 'coc_arrecadacao'] },
    'dtpo3g': { nome: 'DTPO-3G', grupos: ['geral_unificado', 'dtpo3g_atendimentos', 'dtpo3g_analises', 'dtpo3g_operacional'] },
    'dtpo2': { nome: 'DTPO-2', grupos: ['dtpo2_servicos', 'dtpo2_complementar', 'dtpo2_pedestre'] }
};
// ===================================================================================

function showToast(message, type = 'success') {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.className = `show ${type}`;
    setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
}

function gerarCampos() {
    const idSetor = document.getElementById('setorInput').value;
    const container = document.getElementById('camposDinamicos');
    container.innerHTML = '';
    const setorConf = setoresConfig[idSetor];
    if (!setorConf) return;

    setorConf.grupos.forEach(idGrupo => {
        const grupoConf = gruposConfig[idGrupo];
        if (!grupoConf) return;
        const fieldset = document.createElement('fieldset');
        const legend = document.createElement('legend');
        legend.textContent = grupoConf.nome;
        fieldset.appendChild(legend);

        grupoConf.campos.forEach(idCampo => {
            const campoConf = camposConfig[idCampo];
            if (!campoConf || document.getElementById(idCampo)) return;
            const label = document.createElement('label');
            label.setAttribute('for', idCampo);
            label.textContent = campoConf.nome + ':';
            const input = document.createElement('input');
            input.type = 'number'; input.id = idCampo; input.min = '0';
            input.value = campoConf.tipo === 'moeda' ? '0.00' : '0';
            if (campoConf.tipo === 'moeda') input.step = '0.01';
            
            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';
            formGroup.appendChild(label);
            formGroup.appendChild(input);
            fieldset.appendChild(formGroup);
        });
        container.appendChild(fieldset);
    });

    if (idSetor === 'dtpo2') {
        const fieldset = document.createElement('fieldset');
        const legend = document.createElement('legend');
        legend.textContent = 'Relatório Detalhado de Atividades';
        fieldset.appendChild(legend);
        const label = document.createElement('label');
        label.setAttribute('for', 'textoAtividades');
        label.textContent = 'Copie e cole a lista de ruas e serviços realizados aqui:';
        const textarea = document.createElement('textarea');
        textarea.id = 'textoAtividades';

        const formGroup = document.createElement('div');
        formGroup.className = 'form-group';
        formGroup.appendChild(label);
        formGroup.appendChild(textarea);
        fieldset.appendChild(formGroup);
        container.appendChild(fieldset);
    }
}

function adicionarDados() {
    const data = document.getElementById('dataInput').value;
    const idSetor = document.getElementById('setorInput').value;
    if (!data) {
        showToast('O período (Mês/Ano) é obrigatório!', 'error');
        return;
    }

    const novoRegistroNumerico = { data, setor: idSetor };
    let todosCampos = new Set();
    setoresConfig[idSetor].grupos.forEach(idGrupo => {
        gruposConfig[idGrupo].campos.forEach(idCampo => todosCampos.add(idCampo));
    });

    todosCampos.forEach(idCampo => {
        const campoConf = camposConfig[idCampo];
        const input = document.getElementById(idCampo);
        if (input && campoConf) {
           novoRegistroNumerico[idCampo] = campoConf.tipo === 'moeda' ? parseFloat(input.value) || 0 : parseInt(input.value) || 0;
        } else if (campoConf) {
           novoRegistroNumerico[idCampo] = 0;
        }
    });

    let dadosNumericos = localStorage.getItem('dtpoDados') ? JSON.parse(localStorage.getItem('dtpoDados')) : [];
    dadosNumericos.push(novoRegistroNumerico);
    localStorage.setItem('dtpoDados', JSON.stringify(dadosNumericos));

    const textarea = document.getElementById('textoAtividades');
    if (textarea && textarea.value.trim() !== '') {
        const novoRegistroTextual = { data, setor: idSetor, texto: textarea.value.trim() };
        let dadosTextuais = localStorage.getItem('dtpoRegistrosTextuais') ? JSON.parse(localStorage.getItem('dtpoRegistrosTextuais')) : [];
        dadosTextuais.push(novoRegistroTextual);
        localStorage.setItem('dtpoRegistrosTextuais', JSON.stringify(dadosTextuais));
    }

    showToast('Dados adicionados com sucesso!');
    document.getElementById('dataInput').value = '';
    gerarCampos();
}

// Lógica do menu responsivo
document.getElementById('menuToggle').addEventListener('click', function() {
    document.getElementById('mainNav').classList.toggle('nav-open');
});

window.onload = () => {
    const user = localStorage.getItem('dtpoUser');
    const role = localStorage.getItem('dtpoUserRole');
    if (role !== 'admin') {
        alert("Acesso negado. Você não tem permissão para acessar esta página.");
        window.location.href = 'index.html';
        return;
    }
    
    if (user) {
        document.getElementById('userDisplay').innerText = user;
    }
    document.querySelectorAll('.admin-link').forEach(link => {
        link.style.display = 'inline-flex';
    });
    
    const setorSelect = document.getElementById('setorInput');
    Object.keys(setoresConfig).forEach(idSetor => {
        const option = document.createElement('option');
        option.value = idSetor; option.textContent = setoresConfig[idSetor].nome;
        setorSelect.appendChild(option);
    });
    gerarCampos();
    feather.replace();
};
</script>

</body>
</html>